{% extends 'base.html' %}

{% block title %}Diagram - VisualFlow{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    {% if session.status == 'completed' %}
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-4">Your Diagram is Ready! ğŸ‰</h1>
            <p class="text-gray-300">Generated from: "{{ session.prompt }}"</p>
        </div>

        <!-- Diagram Display -->
        <div class="bg-gray-900 rounded-xl shadow-2xl border border-gray-800 p-8 mb-8">
            <!-- Debug: Show raw code -->
            <details class="mb-4 text-gray-400 text-xs">
                <summary class="cursor-pointer hover:text-purple-400">ğŸ”§ Debug: View Mermaid Code</summary>
                <pre class="mt-2 p-4 bg-gray-800 rounded overflow-x-auto">{{ session.diagram_svg }}</pre>
            </details>
            
            <!-- Error display area -->
            <div id="mermaid-error" class="hidden mb-4 p-4 bg-red-900/50 border border-red-500 rounded text-red-200 text-sm">
                <strong>Mermaid Error:</strong> <span id="error-message"></span>
            </div>
            
            <div class="text-center">
                <div id="diagram-container" class="mermaid-diagram p-4 rounded overflow-auto">
                    <!-- Diagram will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-8">
            <a href="{% url 'diagrams:download' session.id %}?format=png" 
               class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-lg transition duration-200 font-semibold shadow-lg">
                ğŸ“¥ Download Image
            </a>
            <a href="{% url 'diagrams:home' %}" 
               class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition duration-200 font-semibold border border-gray-600">
                ğŸ†• Create New
            </a>
        </div>

    {% elif session.status == 'failed' %}
        <!-- Error Display -->
        <div class="text-center py-16">
            <div class="text-6xl mb-4">ğŸ˜</div>
            <h2 class="text-2xl font-bold text-red-400 mb-4">Oops! Something went wrong</h2>
            <p class="text-red-300 mb-6">We couldn't generate your diagram. Please try again.</p>
            <a href="{% url 'diagrams:home' %}" 
               class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-lg transition duration-200 font-semibold shadow-lg">
                ğŸ”„ Try Again
            </a>
        </div>

    {% else %}
        <!-- Processing Display -->
        <div class="text-center py-16">
            <div class="text-6xl mb-4">â³</div>
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">Creating Your Diagram...</h2>
            <p class="text-yellow-300 mb-6">Our AI is working on it. This won't take long!</p>
            <div class="flex justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
            </div>
        </div>
        
        <!-- Auto-refresh -->
        <script>
            setTimeout(() => window.location.reload(), 3000);
        </script>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Manual Mermaid rendering with proper error handling
window.addEventListener('DOMContentLoaded', async function() {
    const diagramCode = `{{ session.diagram_svg|safe|escapejs }}`;
    const container = document.getElementById('diagram-container');
    
    if (!container || !diagramCode.trim()) {
        console.error('No diagram code or container found');
        return;
    }
    
    try {
        // Render the diagram
        const { svg } = await mermaid.render('generatedDiagram', diagramCode);
        container.innerHTML = svg;
        console.log('âœ… Diagram rendered successfully');
    } catch(error) {
        console.error('âŒ Mermaid rendering failed:', error);
        const errorDiv = document.getElementById('mermaid-error');
        const errorSpan = document.getElementById('error-message');
        if (errorDiv && errorSpan) {
            errorSpan.textContent = error.message || error.toString();
            errorDiv.classList.remove('hidden');
        }
        // Show raw code as fallback
        container.innerHTML = `<pre class="text-left text-xs text-gray-800">${diagramCode}</pre>`;
    }
});
</script>
{% endblock %}