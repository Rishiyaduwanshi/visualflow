<!DOCTYPE html>
<html>
<head>
    <title>Download Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="mermaid-container" style="padding: 20px; background: white;">
        <div class="mermaid">{{ mermaid_code|safe }}</div>
    </div>
    
    <div style="text-align: center; margin: 20px;">
        <button onclick="downloadImage('png')">Download PNG</button>
        <button onclick="downloadImage('jpg')">Download JPG</button>
        <button onclick="downloadSVG()">Download SVG</button>
    </div>

    <script>
        mermaid.initialize({ 
            theme: 'default',
            startOnLoad: true,
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true
            }
        });

        async function downloadImage(format) {
            const element = document.getElementById('mermaid-container');
            const canvas = await html2canvas(element, {
                backgroundColor: 'white',
                scale: 2
            });
            
            const link = document.createElement('a');
            link.download = `diagram_{{ session.id }}.${format}`;
            link.href = canvas.toDataURL(`image/${format}`);
            link.click();
        }

        function downloadSVG() {
            const svgElement = document.querySelector('#mermaid-container svg');
            if (svgElement) {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                const link = document.createElement('a');
                link.download = `diagram_{{ session.id }}.svg`;
                link.href = svgUrl;
                link.click();
                
                URL.revokeObjectURL(svgUrl);
            }
        }

        // Auto-download after 2 seconds
        setTimeout(() => {
            downloadImage('{{ format_type }}');
        }, 2000);
    </script>
</body>
</html>